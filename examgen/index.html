<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bloodü©∏Doctor | FRCPath Exam Question Generator</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,500;9..144,600;9..144,700&family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- PDF.js for PDF extraction -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <!-- Mammoth.js for Word documents -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
  <!-- SheetJS for Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Marked for Markdown rendering -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
  <style>
    :root {
      --ink: #11131a;
      --slate: #2b2f3a;
      --muted: #5c6170;
      --blood: #8b0e1c;
      --blood-soft: #b73345;
      --gold: #d7a35d;
      --teal: #0f766e;
      --teal-soft: #cde8e4;
      --rose: #f4d8dd;
      --ivory: #f7f2ed;
      --mist: #f3f6f8;
      --white: #ffffff;
      --shadow: 0 28px 60px rgba(17, 19, 26, 0.18);
      --radius: 22px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Sora', system-ui, sans-serif;
      color: var(--ink);
      background: radial-gradient(circle at top, #ffffff 0%, #f6efe8 38%, #efe3d7 100%);
      min-height: 100vh;
    }

    /* Navigation */
    .nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 5vw;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid rgba(17,19,26,0.08);
    }

    .brand {
      font-size: 1.4rem;
      font-weight: 700;
    }

    .nav-pills {
      display: flex;
      gap: 8px;
    }

    .nav-pill {
      padding: 8px 16px;
      border-radius: 999px;
      font-size: 0.85rem;
      font-weight: 600;
      background: var(--ivory);
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }

    .nav-pill:hover, .nav-pill.active {
      background: var(--blood);
      color: white;
    }

    /* Hero */
    .hero {
      padding: 40px 5vw 30px;
      text-align: center;
    }

    .hero h1 {
      font-family: 'Fraunces', serif;
      font-size: clamp(1.8rem, 3.5vw, 2.8rem);
      margin-bottom: 12px;
    }

    .hero p {
      color: var(--muted);
      max-width: 700px;
      margin: 0 auto;
      line-height: 1.6;
    }

    .pill {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 999px;
      background: var(--rose);
      color: var(--blood);
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 12px;
    }

    /* Main Container */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 5vw 60px;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 4px;
      background: var(--mist);
      padding: 6px;
      border-radius: 14px;
      width: fit-content;
      margin: 0 auto 30px;
    }

    .tab {
      padding: 12px 24px;
      border-radius: 10px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      background: transparent;
      font-family: inherit;
      transition: all 0.2s;
    }

    .tab:hover { background: rgba(255,255,255,0.5); }
    .tab.active { background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

    /* Tab Panels */
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* Grid Layout */
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    @media (max-width: 900px) {
      .grid-2 { grid-template-columns: 1fr; }
    }

    /* Cards */
    .card {
      background: white;
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
    }

    .card h3 {
      font-family: 'Fraunces', serif;
      font-size: 1.3rem;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-tag {
      font-size: 0.7rem;
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--teal-soft);
      color: var(--teal);
      font-weight: 600;
      font-family: 'Sora', sans-serif;
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 18px;
    }

    .form-label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    .form-select, .form-input, .form-textarea {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid rgba(17,19,26,0.15);
      border-radius: 12px;
      font-size: 0.95rem;
      font-family: inherit;
      background: white;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .form-select:focus, .form-input:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--blood);
      box-shadow: 0 0 0 3px rgba(139,14,28,0.1);
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    /* File Upload Zone */
    .upload-zone {
      border: 2px dashed rgba(17,19,26,0.2);
      border-radius: 16px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--mist);
      margin-bottom: 16px;
    }

    .upload-zone:hover, .upload-zone.dragover {
      border-color: var(--blood);
      background: var(--rose);
    }

    .upload-zone.has-files {
      border-color: var(--teal);
      background: var(--teal-soft);
    }

    .upload-icon {
      font-size: 3rem;
      margin-bottom: 12px;
    }

    .upload-text {
      font-weight: 600;
      margin-bottom: 6px;
    }

    .upload-hint {
      font-size: 0.85rem;
      color: var(--muted);
    }

    .file-input {
      display: none;
    }

    /* File List */
    .file-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }

    .file-chip {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      background: white;
      border-radius: 999px;
      font-size: 0.85rem;
      border: 1px solid rgba(17,19,26,0.1);
    }

    .file-chip-icon {
      width: 20px;
      height: 20px;
    }

    .file-chip-remove {
      cursor: pointer;
      color: var(--blood);
      font-weight: bold;
    }

    /* URL Input Group */
    .url-input-group {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .url-input-group input {
      flex: 1;
    }

    .url-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .url-chip {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      background: var(--mist);
      border-radius: 10px;
      font-size: 0.85rem;
    }

    .url-chip-text {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      margin-right: 12px;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 28px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      font-family: inherit;
    }

    .btn-primary {
      background: var(--blood);
      color: white;
      box-shadow: 0 12px 32px rgba(139,14,28,0.25);
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 16px 40px rgba(139,14,28,0.3);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: var(--ivory);
      color: var(--ink);
    }

    .btn-secondary:hover {
      background: var(--rose);
    }

    .btn-teal {
      background: var(--teal);
      color: white;
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 0.85rem;
    }

    .btn-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 20px;
    }

    /* Output Area */
    .output-container {
      background: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .output-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background: var(--mist);
      border-bottom: 1px solid rgba(17,19,26,0.08);
    }

    .output-header h3 {
      font-family: 'Fraunces', serif;
      font-size: 1.2rem;
      margin: 0;
    }

    .output-actions {
      display: flex;
      gap: 8px;
    }

    .output-body {
      padding: 24px;
      min-height: 400px;
      max-height: 70vh;
      overflow-y: auto;
    }

    .output-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 300px;
      color: var(--muted);
      text-align: center;
    }

    .output-placeholder-icon {
      font-size: 4rem;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* Generated Question Styling */
    .generated-question {
      line-height: 1.7;
    }

    .generated-question h1, .generated-question h2, .generated-question h3 {
      font-family: 'Fraunces', serif;
      margin-top: 24px;
      margin-bottom: 12px;
      color: var(--blood);
    }

    .generated-question h1 { font-size: 1.5rem; }
    .generated-question h2 { font-size: 1.3rem; }
    .generated-question h3 { font-size: 1.1rem; }

    .generated-question p {
      margin-bottom: 12px;
    }

    .generated-question ul, .generated-question ol {
      margin-bottom: 12px;
      padding-left: 24px;
    }

    .generated-question li {
      margin-bottom: 6px;
    }

    .generated-question strong {
      color: var(--blood);
    }

    .generated-question code {
      background: var(--mist);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.9em;
    }

    .generated-question pre {
      background: var(--mist);
      padding: 16px;
      border-radius: 12px;
      overflow-x: auto;
      margin-bottom: 12px;
    }

    .generated-question blockquote {
      border-left: 4px solid var(--blood);
      padding-left: 16px;
      margin: 16px 0;
      color: var(--muted);
    }

    .generated-question hr {
      border: none;
      border-top: 2px solid var(--mist);
      margin: 24px 0;
    }

    .generated-question table {
      width: 100%;
      border-collapse: collapse;
      margin: 16px 0;
    }

    .generated-question th, .generated-question td {
      border: 1px solid rgba(17,19,26,0.1);
      padding: 10px 12px;
      text-align: left;
    }

    .generated-question th {
      background: var(--mist);
      font-weight: 600;
    }

    /* Loading State */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 300px;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid var(--mist);
      border-top-color: var(--blood);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      margin-top: 16px;
      font-weight: 600;
      color: var(--muted);
    }

    /* API Key Section */
    .api-key-section {
      background: linear-gradient(135deg, var(--rose) 0%, var(--ivory) 100%);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .api-key-section h4 {
      font-size: 1rem;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .api-key-input-group {
      display: flex;
      gap: 8px;
    }

    .api-key-input-group input {
      flex: 1;
    }

    .api-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
      margin-top: 8px;
    }

    .api-status.connected { color: var(--teal); }
    .api-status.disconnected { color: var(--blood); }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
    }

    /* Source Preview */
    .source-preview {
      background: var(--mist);
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
      max-height: 200px;
      overflow-y: auto;
      font-size: 0.85rem;
      line-height: 1.6;
    }

    .source-preview-header {
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--teal);
    }

    /* Question Count Selector */
    .count-selector {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .count-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 1px solid rgba(17,19,26,0.15);
      background: white;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .count-btn:hover {
      background: var(--ivory);
    }

    .count-display {
      font-size: 1.5rem;
      font-weight: 700;
      min-width: 40px;
      text-align: center;
    }

    /* History Panel */
    .history-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 18px;
      background: var(--mist);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .history-item:hover {
      background: var(--ivory);
    }

    .history-item-info {
      flex: 1;
    }

    .history-item-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .history-item-meta {
      font-size: 0.8rem;
      color: var(--muted);
    }

    /* Callout */
    .callout {
      background: var(--teal-soft);
      border-radius: 12px;
      padding: 14px 18px;
      margin: 16px 0;
      font-size: 0.9rem;
    }

    .callout.warning {
      background: #fff3e6;
      border: 1px solid rgba(215,163,93,0.4);
    }

    .callout strong {
      display: block;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 4px;
    }

    /* Footer */
    .footer {
      padding: 24px 5vw;
      background: var(--ink);
      color: rgba(255,255,255,0.7);
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
      font-size: 0.9rem;
    }

    /* Utility */
    .text-center { text-align: center; }
    .mt-4 { margin-top: 16px; }
    .mb-4 { margin-bottom: 16px; }

    /* Domain selector grid */
    .domain-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
      margin-bottom: 16px;
    }

    .domain-option {
      padding: 12px;
      border-radius: 10px;
      background: var(--mist);
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
      font-size: 0.85rem;
    }

    .domain-option:hover {
      background: var(--ivory);
    }

    .domain-option.selected {
      border-color: var(--blood);
      background: var(--rose);
    }

    /* Image preview */
    .image-preview {
      max-width: 100%;
      max-height: 200px;
      border-radius: 12px;
      margin-top: 12px;
    }

    /* Toast notifications */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 14px 24px;
      background: var(--ink);
      color: white;
      border-radius: 12px;
      font-weight: 600;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      z-index: 1000;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    .toast.success { background: var(--teal); }
    .toast.error { background: var(--blood); }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="nav">
    <div class="brand">Bloodü©∏Doctor</div>
    <div class="nav-pills">
      <button class="nav-pill active" data-tab="generator">Generator</button>
      <button class="nav-pill" data-tab="templates">Templates</button>
      <button class="nav-pill" data-tab="history">History</button>
      <button class="nav-pill" data-tab="settings">Settings</button>
    </div>
  </nav>

  <!-- Hero -->
  <header class="hero">
    <div class="pill">#BloodDoctor | FRCPath Haematology</div>
    <h1>AI Exam Question Generator</h1>
    <p>Upload PDFs, documents, images, or paste URLs to generate complete FRCPath exam questions with detailed answers and explanations.</p>
  </header>

  <!-- Main Container -->
  <main class="container">
    <!-- Generator Tab -->
    <div class="tab-panel active" id="panel-generator">
      <div class="grid-2">
        <!-- Left Column - Input -->
        <div>
          <!-- API Key Section -->
          <div class="api-key-section">
            <h4>üîë Claude API Key</h4>
            <div class="api-key-input-group">
              <input type="password" class="form-input" id="apiKey" placeholder="sk-ant-api...">
              <button class="btn btn-small btn-secondary" onclick="toggleApiKey()">Show</button>
              <button class="btn btn-small btn-teal" onclick="saveApiKey()">Save</button>
            </div>
            <div class="api-status disconnected" id="apiStatus">
              <span class="status-dot"></span>
              <span>Not connected</span>
            </div>
          </div>

          <!-- Source Upload Card -->
          <div class="card mb-4">
            <h3>üìÅ Upload Sources <span class="card-tag">Multiple Formats</span></h3>

            <!-- File Upload Zone -->
            <div class="upload-zone" id="uploadZone">
              <div class="upload-icon">üìÑ</div>
              <div class="upload-text">Drop files here or click to upload</div>
              <div class="upload-hint">PDF, Word, Excel, Images (JPG, PNG), Videos (MP4)</div>
              <input type="file" class="file-input" id="fileInput" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif,.mp4,.mov,.webm">
            </div>
            <div class="file-list" id="fileList"></div>

            <!-- URL Input -->
            <div class="form-group mt-4">
              <label class="form-label">üîó Add URL (Website or YouTube)</label>
              <div class="url-input-group">
                <input type="url" class="form-input" id="urlInput" placeholder="https://example.com or YouTube URL">
                <button class="btn btn-small btn-secondary" onclick="addUrl()">Add</button>
              </div>
              <div class="url-list" id="urlList"></div>
            </div>

            <!-- Source Preview -->
            <div class="source-preview" id="sourcePreview" style="display: none;">
              <div class="source-preview-header">üìù Extracted Content Preview</div>
              <div id="sourcePreviewContent"></div>
            </div>
          </div>

          <!-- Question Settings Card -->
          <div class="card">
            <h3>‚öôÔ∏è Question Settings <span class="card-tag">Configure</span></h3>

            <div class="form-group">
              <label class="form-label">Question Type</label>
              <select class="form-select" id="questionType">
                <option value="emq">Extended Matching Question (EMQ)</option>
                <option value="mcq">Multiple Choice Question (MCQ)</option>
                <option value="essay">Essay Question</option>
                <option value="saq">Short Answer Question (SAQ)</option>
                <option value="case">Clinical Case Study</option>
                <option value="morphology">Morphology Case</option>
                <option value="hplc">HPLC Interpretation</option>
                <option value="viva">Viva Question</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">Difficulty Level</label>
              <select class="form-select" id="difficulty">
                <option value="foundation">Foundation (ST3-4)</option>
                <option value="intermediate">Intermediate (ST5-6)</option>
                <option value="advanced">Advanced (ST7 / Consultant)</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">Number of Questions</label>
              <div class="count-selector">
                <button class="count-btn" onclick="adjustCount(-1)">‚àí</button>
                <span class="count-display" id="questionCount">3</span>
                <button class="count-btn" onclick="adjustCount(1)">+</button>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Clinical Domain (Optional)</label>
              <select class="form-select" id="clinicalDomain">
                <option value="">Auto-detect from source</option>
                <option value="anaemia">Anaemia & Iron Metabolism</option>
                <option value="haemoglobinopathy">Haemoglobinopathies</option>
                <option value="coagulation">Coagulation & Haemostasis</option>
                <option value="thrombosis">Thrombosis & Thrombophilia</option>
                <option value="transfusion">Transfusion Medicine</option>
                <option value="malignant">Malignant Haematology</option>
                <option value="morphology">Blood Film Morphology</option>
                <option value="bonemarrow">Bone Marrow Assessment</option>
                <option value="platelet">Platelet Disorders</option>
                <option value="redcell">Red Cell Disorders</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">Additional Instructions (Optional)</label>
              <textarea class="form-textarea" id="additionalInstructions" placeholder="Focus on specific topics, include certain scenarios, etc."></textarea>
            </div>

            <div class="btn-group">
              <button class="btn btn-primary" id="generateBtn" onclick="generateQuestions()">
                üöÄ Generate Questions
              </button>
              <button class="btn btn-secondary" onclick="clearAll()">Clear All</button>
            </div>
          </div>
        </div>

        <!-- Right Column - Output -->
        <div>
          <div class="output-container">
            <div class="output-header">
              <h3>üìã Generated Questions</h3>
              <div class="output-actions">
                <button class="btn btn-small btn-secondary" onclick="copyOutput()">üìã Copy</button>
                <button class="btn btn-small btn-secondary" onclick="downloadOutput()">üíæ Download</button>
                <button class="btn btn-small btn-teal" onclick="regenerate()">üîÑ Regenerate</button>
              </div>
            </div>
            <div class="output-body" id="outputBody">
              <div class="output-placeholder">
                <div class="output-placeholder-icon">üìù</div>
                <div>Your generated questions will appear here</div>
                <div style="font-size: 0.85rem; margin-top: 8px;">Upload sources and click "Generate Questions"</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Templates Tab -->
    <div class="tab-panel" id="panel-templates">
      <div class="card">
        <h3>üìö Question Templates <span class="card-tag">Reference</span></h3>
        <p class="mb-4">These templates guide the AI in generating properly structured exam questions.</p>

        <div class="form-group">
          <label class="form-label">Select Template to View</label>
          <select class="form-select" id="templateSelect" onchange="showTemplate()">
            <option value="emq">EMQ Template</option>
            <option value="mcq">MCQ Template</option>
            <option value="essay">Essay Template</option>
            <option value="case">Clinical Case Template</option>
            <option value="morphology">Morphology Case Template</option>
            <option value="hplc">HPLC Interpretation Template</option>
          </select>
        </div>

        <div class="source-preview" id="templateDisplay" style="display: block; max-height: 500px;">
          <pre id="templateContent" style="white-space: pre-wrap; margin: 0;"></pre>
        </div>

        <button class="btn btn-secondary mt-4" onclick="copyTemplate()">üìã Copy Template</button>
      </div>
    </div>

    <!-- History Tab -->
    <div class="tab-panel" id="panel-history">
      <div class="card">
        <h3>üìú Generation History <span class="card-tag">Recent</span></h3>
        <div class="history-list" id="historyList">
          <div class="output-placeholder" style="min-height: 200px;">
            <div>No generation history yet</div>
            <div style="font-size: 0.85rem; margin-top: 8px;">Your generated questions will be saved here</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Tab -->
    <div class="tab-panel" id="panel-settings">
      <div class="card">
        <h3>‚öôÔ∏è Settings <span class="card-tag">Configure</span></h3>

        <div class="form-group">
          <label class="form-label">Claude Model</label>
          <select class="form-select" id="modelSelect">
            <option value="claude-sonnet-4-20250514">Claude Sonnet 4 (Recommended)</option>
            <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet</option>
            <option value="claude-3-opus-20240229">Claude 3 Opus (Most Capable)</option>
            <option value="claude-3-haiku-20240307">Claude 3 Haiku (Fastest)</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Default Question Count</label>
          <input type="number" class="form-input" id="defaultCount" value="3" min="1" max="10">
        </div>

        <div class="form-group">
          <label class="form-label">Include Answer Explanations</label>
          <select class="form-select" id="includeExplanations">
            <option value="full">Full explanations with guidelines</option>
            <option value="brief">Brief explanations</option>
            <option value="none">Questions only (no answers)</option>
          </select>
        </div>

        <div class="callout">
          <strong>About the API</strong>
          <p>This app uses the Claude API to generate questions. Your API key is stored locally in your browser and is never sent to any server except Anthropic's API.</p>
        </div>

        <button class="btn btn-secondary" onclick="clearHistory()">üóëÔ∏è Clear History</button>
        <button class="btn btn-secondary" onclick="exportSettings()">üì§ Export Settings</button>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div>Bloodü©∏Doctor | Dr Abdul Mannan FRCPath FCPS | #BloodDoctor</div>
    <div>Framework v1.0 | Powered by Claude AI</div>
  </footer>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script>
    // Initialize PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // State
    let uploadedFiles = [];
    let addedUrls = [];
    let extractedContent = '';
    let generationHistory = JSON.parse(localStorage.getItem('examGenHistory') || '[]');
    let currentOutput = '';

    // Templates
    const templates = {
      emq: `THEME: [Clinical/Laboratory Topic]

CLINICAL SCENARIO:
[2-3 sentence patient presentation with key clinical findings, relevant history, and initial investigations]

LEAD-IN QUESTION:
[Specific question about diagnosis, investigation, management, or mechanism]

OPTIONS:
A. [Option]
B. [Option]
C. [Option]
D. [Option]
E. [Option]
F. [Option]
G. [Option]
H. [Option]

QUESTIONS:
1. [First clinical question - diagnosis/investigation]
2. [Second question - pathophysiology/mechanism]
3. [Third question - management]
4. [Fourth question - monitoring/complications]
5. [Fifth question - prognosis/follow-up]

---

ANSWERS AND EXPLANATIONS:

Question 1: [Answer Letter]
RATIONALE (100-150 words):
- Why this answer is correct
- Relevant guideline reference (BSH/ISTH/NICE)
- Clinical reasoning

WHY OTHER OPTIONS ARE WRONG:
- Option X: [Common misconception]
- Option Y: [When this would be appropriate instead]

CLINICAL PEARL:
[Practical point for real-world practice]`,

      mcq: `QUESTION: [Question ID]
DIFFICULTY: [Foundation/Intermediate/Advanced]
DOMAIN: [Clinical Domain]

STEM:
[Clinical scenario 2-4 sentences with patient details, presentation, and key findings]

What is the most appropriate [next step/diagnosis/investigation/management]?

A. [Option - plausible but incorrect]
B. [Option - partially correct]
C. [CORRECT ANSWER]
D. [Option - common misconception]
E. [Option - outdated practice]

---

ANSWER: C

EXPLANATION (150 words):
[Why C is correct, guideline support, clinical reasoning]

DISTRACTOR ANALYSIS:
A: [Why wrong, what misconception it tests]
B: [Why incomplete, when it might be appropriate]
D: [Common error, why candidates choose this]
E: [Why outdated, current practice]

KEY LEARNING POINTS:
- [Point 1]
- [Point 2]
- [Point 3]

GUIDELINE REFERENCE:
[BSH/ISTH/NICE guideline with year]`,

      essay: `ESSAY QUESTION (20 marks)
TYPE: [Diagnostic Approach / Management Plan / Case Integration / Critical Analysis]
DOMAIN: [Clinical Domain]
EXAM LEVEL: Part 1 / Part 2

QUESTION:
[Full essay question as it would appear in exam]

---

MODEL ANSWER:

INTRODUCTION (2 marks | 80-120 words)
[Clear problem statement, approach overview, key principles]

SECTION 1: [Topic] (5-6 marks | 200-250 words)
[First major area with specific findings, guideline support, practical application]

SECTION 2: [Topic] (5-6 marks | 200-250 words)
[Second major area with alternatives, evidence base, reasoning]

SECTION 3: [Topic] (4-5 marks | 150-200 words)
[Monitoring, follow-up, special considerations]

CONCLUSION (2-3 marks | 100-120 words)
[Synthesis, key decision points, evidence summary]

MARKING GUIDANCE:
- Excellent (18-20): Comprehensive, well-structured, current guidelines
- Good (14-17): Most key points, minor omissions
- Satisfactory (10-13): Basic structure, some gaps
- Poor (<10): Major omissions, factual errors`,

      case: `CLINICAL CASE STUDY
COMPLEXITY: [Foundation/Intermediate/Advanced]
DURATION: [15/20/30 minutes]

PATIENT PRESENTATION:
[Detailed patient demographics, presenting complaint, history]

CLINICAL FINDINGS:
[Examination findings, vital signs]

INVESTIGATIONS:
[Tabulated results with normal ranges]

QUESTION 1 (5 marks):
[Interpretation of findings]

QUESTION 2 (5 marks):
[Differential diagnosis]

QUESTION 3 (5 marks):
[Further investigations]

QUESTION 4 (5 marks):
[Management plan]

---

MODEL ANSWERS:

Q1 ANSWER:
[Detailed interpretation]

Q2 ANSWER:
[Ranked differential with reasoning]

Q3 ANSWER:
[Specific tests with rationale]

Q4 ANSWER:
[Acute and long-term management]`,

      morphology: `MORPHOLOGY CASE
MATERIAL: [Blood Film / BM Aspirate / Trephine Biopsy]
TIME ALLOWED: [9 minutes short case / 30 minutes long case]

CLINICAL CONTEXT:
[Brief patient details and indication for examination]

IMAGE DESCRIPTION:
[Detailed description of what would be seen]

SYSTEMATIC ASSESSMENT:

RED CELLS:
- Size: [normocytic/microcytic/macrocytic]
- Shape: [morphological abnormalities]
- Colour: [hypochromic/normochromic/polychromatic]
- Inclusions: [if any]

WHITE CELLS:
- Count estimate: [low/normal/high]
- Differential: [types seen]
- Morphology: [abnormalities]

PLATELETS:
- Count estimate: [low/normal/high]
- Morphology: [size, granulation]

BACKGROUND:
[Any notable features]

---

SIGNIFICANT FINDINGS:
1. [Finding] - Significance: [interpretation]
2. [Finding] - Significance: [interpretation]
3. [Finding] - Significance: [interpretation]

DIFFERENTIAL DIAGNOSIS:
1. [Most likely] - Supporting features
2. [Alternative] - Why considered
3. [Alternative] - Why less likely

CONFIRMATORY INVESTIGATIONS:
1. [Test] - Expected result
2. [Test] - Expected result

CLINICAL PEARL:
[Practical diagnostic tip]`,

      hplc: `HPLC INTERPRETATION CASE

PATIENT DETAILS:
Age: [X] years
Ethnicity: [relevant background]
Clinical indication: [reason for testing]

HPLC/CE RESULTS:
| Peak | Retention Time | Percentage | Normal Range |
|------|----------------|------------|--------------|
| HbA  | [time]         | [%]        | 96.5-98.5%   |
| HbA2 | [time]         | [%]        | 2.0-3.5%     |
| HbF  | [time]         | [%]        | <1.0%        |
| [Other peaks if present]                           |

ADDITIONAL DATA:
MCV: [value] fL (80-100)
MCH: [value] pg (27-32)
RBC: [value] x10^12/L

---

INTERPRETATION:

ABNORMAL FINDINGS:
1. [Peak abnormality] - Significance
2. [Index abnormality] - Significance

PATTERN RECOGNITION:
[What this combination suggests]

DIFFERENTIAL DIAGNOSIS:
1. [Most likely diagnosis]
2. [Alternative]
3. [Alternative]

CONFIRMATORY TESTS:
1. [Test] - To confirm [what]
2. [Test] - To exclude [what]

CLINICAL IMPLICATIONS:
- For patient: [management needs]
- Genetic counselling: [inheritance, carrier risk]
- Family screening: [who to test]

PITFALL TO AVOID:
[Common misinterpretation]`
    };

    // Tab Navigation
    document.querySelectorAll('.nav-pill').forEach(pill => {
      pill.addEventListener('click', () => {
        document.querySelectorAll('.nav-pill').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        pill.classList.add('active');
        document.getElementById('panel-' + pill.dataset.tab).classList.add('active');
      });
    });

    // File Upload
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');

    uploadZone.addEventListener('click', () => fileInput.click());
    uploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.classList.add('dragover');
    });
    uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('dragover');
      handleFiles(e.dataTransfer.files);
    });
    fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

    async function handleFiles(files) {
      for (const file of files) {
        if (!uploadedFiles.find(f => f.name === file.name)) {
          uploadedFiles.push(file);
          await extractFileContent(file);
        }
      }
      updateFileList();
    }

    async function extractFileContent(file) {
      const type = file.type;
      const name = file.name.toLowerCase();
      let content = '';

      try {
        if (type === 'application/pdf' || name.endsWith('.pdf')) {
          content = await extractPdfContent(file);
        } else if (type.includes('word') || name.endsWith('.docx') || name.endsWith('.doc')) {
          content = await extractWordContent(file);
        } else if (type.includes('sheet') || name.endsWith('.xlsx') || name.endsWith('.xls')) {
          content = await extractExcelContent(file);
        } else if (type.startsWith('image/')) {
          content = `[IMAGE: ${file.name}]\n[Image will be analyzed by Claude Vision]`;
          // Store the image data for API call
          file.imageData = await fileToBase64(file);
        } else if (type.startsWith('video/')) {
          content = `[VIDEO: ${file.name}]\n[Note: Video analysis requires frame extraction - first frame will be analyzed]`;
        } else if (type === 'text/plain') {
          content = await file.text();
        }

        if (content) {
          extractedContent += `\n\n=== SOURCE: ${file.name} ===\n${content}`;
          updateSourcePreview();
        }
      } catch (error) {
        console.error('Error extracting content:', error);
        showToast('Error extracting content from ' + file.name, 'error');
      }
    }

    async function extractPdfContent(file) {
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      let text = '';

      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        const pageText = content.items.map(item => item.str).join(' ');
        text += `\n[Page ${i}]\n${pageText}`;
      }

      return text;
    }

    async function extractWordContent(file) {
      const arrayBuffer = await file.arrayBuffer();
      const result = await mammoth.extractRawText({ arrayBuffer });
      return result.value;
    }

    async function extractExcelContent(file) {
      const arrayBuffer = await file.arrayBuffer();
      const workbook = XLSX.read(arrayBuffer, { type: 'array' });
      let text = '';

      workbook.SheetNames.forEach(sheetName => {
        const sheet = workbook.Sheets[sheetName];
        text += `\n[Sheet: ${sheetName}]\n`;
        text += XLSX.utils.sheet_to_csv(sheet);
      });

      return text;
    }

    async function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    function updateFileList() {
      const list = document.getElementById('fileList');
      list.innerHTML = uploadedFiles.map((file, index) => `
        <div class="file-chip">
          <span>${getFileIcon(file.type)}</span>
          <span>${file.name}</span>
          <span class="file-chip-remove" onclick="removeFile(${index})">√ó</span>
        </div>
      `).join('');

      uploadZone.classList.toggle('has-files', uploadedFiles.length > 0);
    }

    function getFileIcon(type) {
      if (type.includes('pdf')) return 'üìÑ';
      if (type.includes('word')) return 'üìù';
      if (type.includes('sheet') || type.includes('excel')) return 'üìä';
      if (type.startsWith('image/')) return 'üñºÔ∏è';
      if (type.startsWith('video/')) return 'üé¨';
      return 'üìÅ';
    }

    function removeFile(index) {
      uploadedFiles.splice(index, 1);
      updateFileList();
      rebuildExtractedContent();
    }

    function rebuildExtractedContent() {
      extractedContent = '';
      uploadedFiles.forEach(async file => {
        await extractFileContent(file);
      });
    }

    // URL Management
    function addUrl() {
      const input = document.getElementById('urlInput');
      const url = input.value.trim();

      if (!url) return;
      if (!url.startsWith('http')) {
        showToast('Please enter a valid URL', 'error');
        return;
      }

      if (!addedUrls.includes(url)) {
        addedUrls.push(url);
        updateUrlList();
        fetchUrlContent(url);
      }

      input.value = '';
    }

    function updateUrlList() {
      const list = document.getElementById('urlList');
      list.innerHTML = addedUrls.map((url, index) => `
        <div class="url-chip">
          <span>${url.includes('youtube') || url.includes('youtu.be') ? 'üé¨' : 'üîó'}</span>
          <span class="url-chip-text">${url}</span>
          <span class="file-chip-remove" onclick="removeUrl(${index})">√ó</span>
        </div>
      `).join('');
    }

    function removeUrl(index) {
      addedUrls.splice(index, 1);
      updateUrlList();
    }

    async function fetchUrlContent(url) {
      // For YouTube, we'll note it for the API to handle
      if (url.includes('youtube') || url.includes('youtu.be')) {
        extractedContent += `\n\n=== SOURCE: YouTube Video ===\nURL: ${url}\n[YouTube transcript/content will be analyzed]`;
      } else {
        extractedContent += `\n\n=== SOURCE: Website ===\nURL: ${url}\n[Website content will be fetched and analyzed]`;
      }
      updateSourcePreview();
    }

    function updateSourcePreview() {
      const preview = document.getElementById('sourcePreview');
      const content = document.getElementById('sourcePreviewContent');

      if (extractedContent.trim()) {
        preview.style.display = 'block';
        content.textContent = extractedContent.substring(0, 2000) + (extractedContent.length > 2000 ? '...' : '');
      } else {
        preview.style.display = 'none';
      }
    }

    // Question Count
    let questionCount = 3;

    function adjustCount(delta) {
      questionCount = Math.max(1, Math.min(10, questionCount + delta));
      document.getElementById('questionCount').textContent = questionCount;
    }

    // API Key Management
    function saveApiKey() {
      const key = document.getElementById('apiKey').value.trim();
      if (key) {
        localStorage.setItem('claudeApiKey', key);
        updateApiStatus(true);
        showToast('API key saved!', 'success');
      }
    }

    function toggleApiKey() {
      const input = document.getElementById('apiKey');
      const btn = event.target;
      if (input.type === 'password') {
        input.type = 'text';
        btn.textContent = 'Hide';
      } else {
        input.type = 'password';
        btn.textContent = 'Show';
      }
    }

    function updateApiStatus(connected) {
      const status = document.getElementById('apiStatus');
      status.className = 'api-status ' + (connected ? 'connected' : 'disconnected');
      status.innerHTML = `<span class="status-dot"></span><span>${connected ? 'API key saved' : 'Not connected'}</span>`;
    }

    // Load saved API key
    const savedKey = localStorage.getItem('claudeApiKey');
    if (savedKey) {
      document.getElementById('apiKey').value = savedKey;
      updateApiStatus(true);
    }

    // Generate Questions
    async function generateQuestions() {
      const apiKey = localStorage.getItem('claudeApiKey');

      if (!apiKey) {
        showToast('Please enter your Claude API key first', 'error');
        return;
      }

      if (!extractedContent.trim() && uploadedFiles.length === 0 && addedUrls.length === 0) {
        showToast('Please upload a source or add a URL first', 'error');
        return;
      }

      const questionType = document.getElementById('questionType').value;
      const difficulty = document.getElementById('difficulty').value;
      const domain = document.getElementById('clinicalDomain').value;
      const instructions = document.getElementById('additionalInstructions').value;
      const model = document.getElementById('modelSelect')?.value || 'claude-sonnet-4-20250514';
      const explanations = document.getElementById('includeExplanations')?.value || 'full';

      // Show loading
      const outputBody = document.getElementById('outputBody');
      outputBody.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <div class="loading-text">Generating ${questionCount} ${questionType.toUpperCase()} question(s)...</div>
        </div>
      `;

      document.getElementById('generateBtn').disabled = true;

      try {
        // Build the prompt
        const systemPrompt = buildSystemPrompt(questionType, difficulty, domain, explanations);
        const userPrompt = buildUserPrompt(questionType, questionCount, instructions);

        // Prepare messages
        const messages = [{
          role: 'user',
          content: []
        }];

        // Add images if any
        for (const file of uploadedFiles) {
          if (file.imageData) {
            messages[0].content.push({
              type: 'image',
              source: {
                type: 'base64',
                media_type: file.type,
                data: file.imageData
              }
            });
          }
        }

        // Add text content
        messages[0].content.push({
          type: 'text',
          text: userPrompt
        });

        // Call Claude API
        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': apiKey,
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true'
          },
          body: JSON.stringify({
            model: model,
            max_tokens: 8192,
            system: systemPrompt,
            messages: messages
          })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error?.message || 'API request failed');
        }

        const data = await response.json();
        currentOutput = data.content[0].text;

        // Display the result
        outputBody.innerHTML = `<div class="generated-question">${marked.parse(currentOutput)}</div>`;

        // Save to history
        saveToHistory(questionType, difficulty, currentOutput);

        showToast('Questions generated successfully!', 'success');

      } catch (error) {
        console.error('Generation error:', error);
        outputBody.innerHTML = `
          <div class="output-placeholder">
            <div class="output-placeholder-icon">‚ùå</div>
            <div style="color: var(--blood);">Error: ${error.message}</div>
            <div style="font-size: 0.85rem; margin-top: 8px;">Please check your API key and try again</div>
          </div>
        `;
        showToast('Error generating questions', 'error');
      }

      document.getElementById('generateBtn').disabled = false;
    }

    function buildSystemPrompt(questionType, difficulty, domain, explanations) {
      const typeDescriptions = {
        emq: 'Extended Matching Questions with themes, options, and multiple linked questions',
        mcq: 'Single Best Answer Multiple Choice Questions with 5 options',
        essay: 'Structured Essay Questions with model answers and marking guidance',
        saq: 'Short Answer Questions requiring concise focused responses',
        case: 'Clinical Case Studies with progressive questions',
        morphology: 'Morphology Cases describing blood film or bone marrow findings',
        hplc: 'HPLC/Haemoglobin Electrophoresis interpretation cases',
        viva: 'Viva-style oral examination questions and expected answers'
      };

      const difficultyGuide = {
        foundation: 'ST3-4 trainee level - test core knowledge and common presentations',
        intermediate: 'ST5-6 trainee level - test application and clinical reasoning',
        advanced: 'ST7/Consultant level - test complex scenarios and expert judgement'
      };

      return `You are an expert FRCPath Haematology examiner creating high-quality exam questions for UK haematology trainees.

QUESTION TYPE: ${typeDescriptions[questionType]}
DIFFICULTY: ${difficultyGuide[difficulty]}
${domain ? `CLINICAL DOMAIN: ${domain}` : ''}

CORE REQUIREMENTS:
1. All content must be evidence-based and aligned with current BSH, ISTH, NICE, and UK guidelines
2. Questions must reflect real-world UK haematology practice
3. Use correct medical terminology and UK spelling
4. Include specific guideline references where relevant
5. Test clinical reasoning, not just recall

${explanations === 'full' ? `
ANSWER REQUIREMENTS:
- Provide detailed explanations for correct answers (100-150 words)
- Explain why each incorrect option is wrong
- Include relevant guideline references
- Add clinical pearls and learning points
` : explanations === 'brief' ? `
ANSWER REQUIREMENTS:
- Provide brief explanations (50-75 words)
- State correct answer with key reasoning
` : `
OUTPUT: Questions only, no answers or explanations
`}

FORMAT: Use clear markdown formatting with headers, bullet points, and tables where appropriate.
Always include #BloodDoctor at the end.`;
    }

    function buildUserPrompt(questionType, count, instructions) {
      let prompt = `Based on the following source material, generate ${count} ${questionType.toUpperCase()} question(s).

=== SOURCE MATERIAL ===
${extractedContent}

=== URLS TO REFERENCE ===
${addedUrls.join('\n')}

=== INSTRUCTIONS ===
${instructions || 'Generate comprehensive exam questions covering the key topics in the source material.'}

Please generate exactly ${count} complete, exam-ready question(s) following the appropriate template structure.`;

      return prompt;
    }

    function saveToHistory(type, difficulty, content) {
      const item = {
        id: Date.now(),
        type: type,
        difficulty: difficulty,
        timestamp: new Date().toISOString(),
        preview: content.substring(0, 100) + '...',
        content: content
      };

      generationHistory.unshift(item);
      if (generationHistory.length > 50) generationHistory.pop();

      localStorage.setItem('examGenHistory', JSON.stringify(generationHistory));
      updateHistoryList();
    }

    function updateHistoryList() {
      const list = document.getElementById('historyList');

      if (generationHistory.length === 0) {
        list.innerHTML = `
          <div class="output-placeholder" style="min-height: 200px;">
            <div>No generation history yet</div>
          </div>
        `;
        return;
      }

      list.innerHTML = generationHistory.map(item => `
        <div class="history-item" onclick="loadFromHistory(${item.id})">
          <div class="history-item-info">
            <div class="history-item-title">${item.type.toUpperCase()} - ${item.difficulty}</div>
            <div class="history-item-meta">${new Date(item.timestamp).toLocaleString()}</div>
          </div>
          <button class="btn btn-small btn-secondary" onclick="event.stopPropagation(); deleteFromHistory(${item.id})">üóëÔ∏è</button>
        </div>
      `).join('');
    }

    function loadFromHistory(id) {
      const item = generationHistory.find(h => h.id === id);
      if (item) {
        currentOutput = item.content;
        document.getElementById('outputBody').innerHTML = `<div class="generated-question">${marked.parse(item.content)}</div>`;
        document.querySelector('.nav-pill[data-tab="generator"]').click();
        showToast('Loaded from history', 'success');
      }
    }

    function deleteFromHistory(id) {
      generationHistory = generationHistory.filter(h => h.id !== id);
      localStorage.setItem('examGenHistory', JSON.stringify(generationHistory));
      updateHistoryList();
      showToast('Deleted from history', 'success');
    }

    function clearHistory() {
      if (confirm('Clear all generation history?')) {
        generationHistory = [];
        localStorage.setItem('examGenHistory', '[]');
        updateHistoryList();
        showToast('History cleared', 'success');
      }
    }

    // Output Actions
    function copyOutput() {
      if (currentOutput) {
        navigator.clipboard.writeText(currentOutput);
        showToast('Copied to clipboard!', 'success');
      }
    }

    function downloadOutput() {
      if (currentOutput) {
        const blob = new Blob([currentOutput], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `frcpath-questions-${Date.now()}.md`;
        a.click();
        URL.revokeObjectURL(url);
        showToast('Downloaded!', 'success');
      }
    }

    function regenerate() {
      generateQuestions();
    }

    function clearAll() {
      uploadedFiles = [];
      addedUrls = [];
      extractedContent = '';
      updateFileList();
      updateUrlList();
      updateSourcePreview();
      document.getElementById('additionalInstructions').value = '';
      document.getElementById('outputBody').innerHTML = `
        <div class="output-placeholder">
          <div class="output-placeholder-icon">üìù</div>
          <div>Your generated questions will appear here</div>
        </div>
      `;
      currentOutput = '';
    }

    // Templates
    function showTemplate() {
      const type = document.getElementById('templateSelect').value;
      document.getElementById('templateContent').textContent = templates[type];
    }

    function copyTemplate() {
      const type = document.getElementById('templateSelect').value;
      navigator.clipboard.writeText(templates[type]);
      showToast('Template copied!', 'success');
    }

    // Settings
    function exportSettings() {
      const settings = {
        model: document.getElementById('modelSelect')?.value,
        defaultCount: document.getElementById('defaultCount')?.value,
        explanations: document.getElementById('includeExplanations')?.value,
        history: generationHistory
      };

      const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'examgen-settings.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    // Toast
    function showToast(message, type = '') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast show ' + type;
      setTimeout(() => toast.className = 'toast', 3000);
    }

    // Initialize
    showTemplate();
    updateHistoryList();
  </script>
</body>
</html>
