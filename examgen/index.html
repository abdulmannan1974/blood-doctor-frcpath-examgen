<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bloodü©∏Doctor | FRCPath Exam Question Generator</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,500;9..144,600;9..144,700&family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- PDF.js for PDF extraction -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <!-- Mammoth.js for Word documents -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
  <!-- SheetJS for Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Marked for Markdown rendering -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
  <style>
    :root {
      --ink: #11131a;
      --slate: #2b2f3a;
      --muted: #5c6170;
      --blood: #8b0e1c;
      --blood-soft: #b73345;
      --gold: #d7a35d;
      --teal: #0f766e;
      --teal-soft: #cde8e4;
      --rose: #f4d8dd;
      --ivory: #f7f2ed;
      --mist: #f3f6f8;
      --white: #ffffff;
      --shadow: 0 28px 60px rgba(17, 19, 26, 0.18);
      --radius: 22px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Sora', system-ui, sans-serif;
      color: var(--ink);
      background: radial-gradient(circle at top, #ffffff 0%, #f6efe8 38%, #efe3d7 100%);
      min-height: 100vh;
    }

    /* Navigation */
    .nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 5vw;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid rgba(17,19,26,0.08);
    }

    .brand {
      font-size: 1.4rem;
      font-weight: 700;
    }

    .nav-pills {
      display: flex;
      gap: 8px;
    }

    .nav-pill {
      padding: 8px 16px;
      border-radius: 999px;
      font-size: 0.85rem;
      font-weight: 600;
      background: var(--ivory);
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }

    .nav-pill:hover, .nav-pill.active {
      background: var(--blood);
      color: white;
    }

    /* Hero */
    .hero {
      padding: 40px 5vw 30px;
      text-align: center;
    }

    .hero h1 {
      font-family: 'Fraunces', serif;
      font-size: clamp(1.8rem, 3.5vw, 2.8rem);
      margin-bottom: 12px;
    }

    .hero p {
      color: var(--muted);
      max-width: 700px;
      margin: 0 auto;
      line-height: 1.6;
    }

    .pill {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 999px;
      background: var(--rose);
      color: var(--blood);
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 12px;
    }

    /* Main Container */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 5vw 60px;
    }

    /* Grid Layout */
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    @media (max-width: 900px) {
      .grid-2 { grid-template-columns: 1fr; }
    }

    /* Cards */
    .card {
      background: white;
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
    }

    .card h3 {
      font-family: 'Fraunces', serif;
      font-size: 1.3rem;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-tag {
      font-size: 0.7rem;
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--teal-soft);
      color: var(--teal);
      font-weight: 600;
      font-family: 'Sora', sans-serif;
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 18px;
    }

    .form-label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    .form-select, .form-input, .form-textarea {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid rgba(17,19,26,0.15);
      border-radius: 12px;
      font-size: 0.95rem;
      font-family: inherit;
      background: white;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .form-select:focus, .form-input:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--blood);
      box-shadow: 0 0 0 3px rgba(139,14,28,0.1);
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    /* File Upload Zone */
    .upload-zone {
      border: 2px dashed rgba(17,19,26,0.2);
      border-radius: 16px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--mist);
      margin-bottom: 16px;
    }

    .upload-zone:hover, .upload-zone.dragover {
      border-color: var(--blood);
      background: var(--rose);
    }

    .upload-zone.has-files {
      border-color: var(--teal);
      background: var(--teal-soft);
    }

    .upload-icon {
      font-size: 3rem;
      margin-bottom: 12px;
    }

    .upload-text {
      font-weight: 600;
      margin-bottom: 6px;
    }

    .upload-hint {
      font-size: 0.85rem;
      color: var(--muted);
    }

    .file-input {
      display: none;
    }

    /* File List */
    .file-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }

    .file-chip {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      background: white;
      border-radius: 999px;
      font-size: 0.85rem;
      border: 1px solid rgba(17,19,26,0.1);
    }

    .file-chip-remove {
      cursor: pointer;
      color: var(--blood);
      font-weight: bold;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 28px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      font-family: inherit;
    }

    .btn-primary {
      background: var(--blood);
      color: white;
      box-shadow: 0 12px 32px rgba(139,14,28,0.25);
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 16px 40px rgba(139,14,28,0.3);
    }

    .btn-secondary {
      background: var(--ivory);
      color: var(--ink);
    }

    .btn-secondary:hover {
      background: var(--rose);
    }

    .btn-teal {
      background: var(--teal);
      color: white;
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 0.85rem;
    }

    .btn-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 20px;
    }

    /* Output Area */
    .output-container {
      background: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .output-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background: var(--mist);
      border-bottom: 1px solid rgba(17,19,26,0.08);
    }

    .output-header h3 {
      font-family: 'Fraunces', serif;
      font-size: 1.2rem;
      margin: 0;
    }

    .output-actions {
      display: flex;
      gap: 8px;
    }

    .output-body {
      padding: 24px;
      min-height: 400px;
      max-height: 70vh;
      overflow-y: auto;
    }

    .output-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 300px;
      color: var(--muted);
      text-align: center;
    }

    .output-placeholder-icon {
      font-size: 4rem;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* Prompt Output for Claude Code */
    .prompt-output {
      background: #1e1e2e;
      color: #cdd6f4;
      border-radius: 12px;
      padding: 20px;
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 0.85rem;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 500px;
      overflow-y: auto;
    }

    .prompt-output .highlight {
      color: #f5c2e7;
    }

    .prompt-output .comment {
      color: #6c7086;
    }

    /* Instructions Panel */
    .instructions-panel {
      background: linear-gradient(135deg, var(--teal-soft) 0%, #e8f5f3 100%);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid rgba(15, 118, 110, 0.2);
    }

    .instructions-panel h4 {
      color: var(--teal);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .instructions-panel ol {
      padding-left: 20px;
      line-height: 1.8;
    }

    .instructions-panel li {
      margin-bottom: 8px;
    }

    .instructions-panel code {
      background: rgba(15, 118, 110, 0.15);
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.9em;
    }

    /* Source Preview */
    .source-preview {
      background: var(--mist);
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
      max-height: 200px;
      overflow-y: auto;
      font-size: 0.85rem;
      line-height: 1.6;
    }

    .source-preview-header {
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--teal);
    }

    /* Question Count Selector */
    .count-selector {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .count-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 1px solid rgba(17,19,26,0.15);
      background: white;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .count-btn:hover {
      background: var(--ivory);
    }

    .count-display {
      font-size: 1.5rem;
      font-weight: 700;
      min-width: 40px;
      text-align: center;
    }

    /* Callout */
    .callout {
      background: var(--teal-soft);
      border-radius: 12px;
      padding: 14px 18px;
      margin: 16px 0;
      font-size: 0.9rem;
    }

    .callout.warning {
      background: #fff3e6;
      border: 1px solid rgba(215,163,93,0.4);
    }

    .callout.info {
      background: var(--rose);
      border: 1px solid rgba(139,14,28,0.2);
    }

    .callout strong {
      display: block;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 4px;
    }

    /* Footer */
    .footer {
      padding: 24px 5vw;
      background: var(--ink);
      color: rgba(255,255,255,0.7);
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
      font-size: 0.9rem;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 14px 24px;
      background: var(--ink);
      color: white;
      border-radius: 12px;
      font-weight: 600;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      z-index: 1000;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    .toast.success { background: var(--teal); }
    .toast.error { background: var(--blood); }

    /* Step indicator */
    .step-indicator {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 24px;
    }

    .step {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--mist);
      border-radius: 999px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .step.active {
      background: var(--blood);
      color: white;
    }

    .step.completed {
      background: var(--teal);
      color: white;
    }

    .step-number {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(255,255,255,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
    }

    /* URL Input */
    .url-input-group {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .url-input-group input {
      flex: 1;
    }

    .url-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .url-chip {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      background: var(--mist);
      border-radius: 10px;
      font-size: 0.85rem;
    }

    .url-chip-text {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      margin-right: 12px;
    }

    /* Copy success animation */
    @keyframes copySuccess {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    .copy-success {
      animation: copySuccess 0.3s ease;
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="nav">
    <div class="brand">Bloodü©∏Doctor</div>
    <div class="nav-pills">
      <span class="pill" style="background: var(--teal-soft); color: var(--teal);">Claude Code Edition</span>
    </div>
  </nav>

  <!-- Hero -->
  <header class="hero">
    <div class="pill">#BloodDoctor | FRCPath Haematology</div>
    <h1>AI Exam Question Generator</h1>
    <p>Upload your source materials, configure settings, and generate a prompt to paste into Claude Code for complete exam questions.</p>
  </header>

  <!-- Main Container -->
  <main class="container">
    <!-- Instructions Panel -->
    <div class="instructions-panel">
      <h4>üìã How to Use with Claude Code</h4>
      <ol>
        <li><strong>Upload sources</strong> - Add PDFs, Word docs, Excel files, images, or URLs below</li>
        <li><strong>Configure settings</strong> - Choose question type, difficulty, and number of questions</li>
        <li><strong>Generate prompt</strong> - Click the button to create your prompt</li>
        <li><strong>Copy the prompt</strong> - Use the copy button to copy everything</li>
        <li><strong>Paste into Claude Code</strong> - Claude will generate complete questions with answers!</li>
      </ol>
    </div>

    <!-- Step Indicator -->
    <div class="step-indicator">
      <div class="step active" id="step1">
        <span class="step-number">1</span>
        <span>Add Sources</span>
      </div>
      <div class="step" id="step2">
        <span class="step-number">2</span>
        <span>Configure</span>
      </div>
      <div class="step" id="step3">
        <span class="step-number">3</span>
        <span>Generate</span>
      </div>
    </div>

    <div class="grid-2">
      <!-- Left Column - Input -->
      <div>
        <!-- Source Upload Card -->
        <div class="card">
          <h3>üìÅ Upload Sources <span class="card-tag">Step 1</span></h3>

          <!-- File Upload Zone -->
          <div class="upload-zone" id="uploadZone">
            <div class="upload-icon">üìÑ</div>
            <div class="upload-text">Drop files here or click to upload</div>
            <div class="upload-hint">PDF, Word, Excel, Images (JPG, PNG), Text files</div>
            <input type="file" class="file-input" id="fileInput" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif,.txt,.md">
          </div>
          <div class="file-list" id="fileList"></div>

          <!-- URL Input -->
          <div class="form-group" style="margin-top: 16px;">
            <label class="form-label">üîó Add URL (Website or YouTube)</label>
            <div class="url-input-group">
              <input type="url" class="form-input" id="urlInput" placeholder="https://example.com or YouTube URL">
              <button class="btn btn-small btn-secondary" onclick="addUrl()">Add</button>
            </div>
            <div class="url-list" id="urlList"></div>
          </div>

          <!-- Direct Text Input -->
          <div class="form-group">
            <label class="form-label">üìù Or paste text directly</label>
            <textarea class="form-textarea" id="directText" placeholder="Paste article text, guidelines, or any content here..." style="min-height: 120px;"></textarea>
          </div>

          <!-- Source Preview -->
          <div class="source-preview" id="sourcePreview" style="display: none;">
            <div class="source-preview-header">üìù Extracted Content Preview</div>
            <div id="sourcePreviewContent"></div>
          </div>
        </div>

        <!-- Question Settings Card -->
        <div class="card">
          <h3>‚öôÔ∏è Question Settings <span class="card-tag">Step 2</span></h3>

          <div class="form-group">
            <label class="form-label">Question Type</label>
            <select class="form-select" id="questionType">
              <option value="emq">Extended Matching Question (EMQ)</option>
              <option value="mcq">Multiple Choice Question (MCQ)</option>
              <option value="essay">Essay Question</option>
              <option value="saq">Short Answer Question (SAQ)</option>
              <option value="case">Clinical Case Study</option>
              <option value="morphology">Morphology Case</option>
              <option value="hplc">HPLC Interpretation</option>
              <option value="viva">Viva Question</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Difficulty Level</label>
            <select class="form-select" id="difficulty">
              <option value="foundation">Foundation (ST3-4)</option>
              <option value="intermediate">Intermediate (ST5-6)</option>
              <option value="advanced">Advanced (ST7 / Consultant)</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Number of Questions</label>
            <div class="count-selector">
              <button class="count-btn" onclick="adjustCount(-1)">‚àí</button>
              <span class="count-display" id="questionCount">3</span>
              <button class="count-btn" onclick="adjustCount(1)">+</button>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Clinical Domain (Optional)</label>
            <select class="form-select" id="clinicalDomain">
              <option value="">Auto-detect from source</option>
              <option value="anaemia">Anaemia & Iron Metabolism</option>
              <option value="haemoglobinopathy">Haemoglobinopathies</option>
              <option value="coagulation">Coagulation & Haemostasis</option>
              <option value="thrombosis">Thrombosis & Thrombophilia</option>
              <option value="transfusion">Transfusion Medicine</option>
              <option value="malignant">Malignant Haematology</option>
              <option value="morphology">Blood Film Morphology</option>
              <option value="bonemarrow">Bone Marrow Assessment</option>
              <option value="platelet">Platelet Disorders</option>
              <option value="redcell">Red Cell Disorders</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Additional Instructions (Optional)</label>
            <textarea class="form-textarea" id="additionalInstructions" placeholder="Focus on specific topics, include certain scenarios, etc." style="min-height: 80px;"></textarea>
          </div>

          <div class="btn-group">
            <button class="btn btn-primary" onclick="generatePrompt()">
              üöÄ Generate Prompt for Claude
            </button>
            <button class="btn btn-secondary" onclick="clearAll()">Clear All</button>
          </div>
        </div>
      </div>

      <!-- Right Column - Output -->
      <div>
        <div class="output-container">
          <div class="output-header">
            <h3>üìã Generated Prompt <span class="card-tag">Step 3</span></h3>
            <div class="output-actions">
              <button class="btn btn-small btn-teal" id="copyBtn" onclick="copyPrompt()">üìã Copy Prompt</button>
            </div>
          </div>
          <div class="output-body" id="outputBody">
            <div class="output-placeholder">
              <div class="output-placeholder-icon">üí¨</div>
              <div>Your prompt will appear here</div>
              <div style="font-size: 0.85rem; margin-top: 8px;">Configure settings and click "Generate Prompt"</div>
            </div>
          </div>
        </div>

        <div class="callout info" style="margin-top: 20px;">
          <strong>üí° Tip</strong>
          <p>After copying the prompt, paste it directly into Claude Code. Claude will read your source material and generate complete, exam-ready questions with detailed answers and explanations!</p>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div>Bloodü©∏Doctor | Dr Abdul Mannan FRCPath FCPS | #BloodDoctor</div>
    <div>Framework v1.0 | For use with Claude Code</div>
  </footer>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script>
    // Initialize PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // State
    let uploadedFiles = [];
    let addedUrls = [];
    let extractedContent = '';
    let generatedPrompt = '';

    // File Upload
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');

    uploadZone.addEventListener('click', () => fileInput.click());
    uploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.classList.add('dragover');
    });
    uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('dragover');
      handleFiles(e.dataTransfer.files);
    });
    fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

    async function handleFiles(files) {
      for (const file of files) {
        if (!uploadedFiles.find(f => f.name === file.name)) {
          uploadedFiles.push(file);
          await extractFileContent(file);
        }
      }
      updateFileList();
      updateSteps();
    }

    async function extractFileContent(file) {
      const type = file.type;
      const name = file.name.toLowerCase();
      let content = '';

      try {
        if (type === 'application/pdf' || name.endsWith('.pdf')) {
          content = await extractPdfContent(file);
        } else if (type.includes('word') || name.endsWith('.docx') || name.endsWith('.doc')) {
          content = await extractWordContent(file);
        } else if (type.includes('sheet') || name.endsWith('.xlsx') || name.endsWith('.xls')) {
          content = await extractExcelContent(file);
        } else if (type.startsWith('image/')) {
          content = `[IMAGE FILE: ${file.name}]\n[Please describe this image or include relevant text from it in the prompt]`;
        } else if (type === 'text/plain' || name.endsWith('.txt') || name.endsWith('.md')) {
          content = await file.text();
        }

        if (content) {
          extractedContent += `\n\n=== SOURCE: ${file.name} ===\n${content}`;
          updateSourcePreview();
        }
      } catch (error) {
        console.error('Error extracting content:', error);
        showToast('Error extracting content from ' + file.name, 'error');
      }
    }

    async function extractPdfContent(file) {
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      let text = '';

      for (let i = 1; i <= Math.min(pdf.numPages, 50); i++) { // Limit to 50 pages
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        const pageText = content.items.map(item => item.str).join(' ');
        text += `\n[Page ${i}]\n${pageText}`;
      }

      return text;
    }

    async function extractWordContent(file) {
      const arrayBuffer = await file.arrayBuffer();
      const result = await mammoth.extractRawText({ arrayBuffer });
      return result.value;
    }

    async function extractExcelContent(file) {
      const arrayBuffer = await file.arrayBuffer();
      const workbook = XLSX.read(arrayBuffer, { type: 'array' });
      let text = '';

      workbook.SheetNames.forEach(sheetName => {
        const sheet = workbook.Sheets[sheetName];
        text += `\n[Sheet: ${sheetName}]\n`;
        text += XLSX.utils.sheet_to_csv(sheet);
      });

      return text;
    }

    function updateFileList() {
      const list = document.getElementById('fileList');
      list.innerHTML = uploadedFiles.map((file, index) => `
        <div class="file-chip">
          <span>${getFileIcon(file.type, file.name)}</span>
          <span>${file.name}</span>
          <span class="file-chip-remove" onclick="removeFile(${index})">√ó</span>
        </div>
      `).join('');

      uploadZone.classList.toggle('has-files', uploadedFiles.length > 0);
    }

    function getFileIcon(type, name) {
      if (type.includes('pdf') || name.endsWith('.pdf')) return 'üìÑ';
      if (type.includes('word') || name.endsWith('.docx') || name.endsWith('.doc')) return 'üìù';
      if (type.includes('sheet') || type.includes('excel') || name.endsWith('.xlsx') || name.endsWith('.xls')) return 'üìä';
      if (type.startsWith('image/')) return 'üñºÔ∏è';
      return 'üìÅ';
    }

    function removeFile(index) {
      uploadedFiles.splice(index, 1);
      updateFileList();
      rebuildExtractedContent();
      updateSteps();
    }

    async function rebuildExtractedContent() {
      extractedContent = '';
      for (const file of uploadedFiles) {
        await extractFileContent(file);
      }
    }

    // URL Management
    function addUrl() {
      const input = document.getElementById('urlInput');
      const url = input.value.trim();

      if (!url) return;
      if (!url.startsWith('http')) {
        showToast('Please enter a valid URL', 'error');
        return;
      }

      if (!addedUrls.includes(url)) {
        addedUrls.push(url);
        updateUrlList();

        if (url.includes('youtube') || url.includes('youtu.be')) {
          extractedContent += `\n\n=== SOURCE: YouTube Video ===\nURL: ${url}\n[Please watch this video and extract the relevant content for question generation]`;
        } else {
          extractedContent += `\n\n=== SOURCE: Website ===\nURL: ${url}\n[Please visit this URL and extract the relevant content for question generation]`;
        }
        updateSourcePreview();
        updateSteps();
      }

      input.value = '';
    }

    function updateUrlList() {
      const list = document.getElementById('urlList');
      list.innerHTML = addedUrls.map((url, index) => `
        <div class="url-chip">
          <span>${url.includes('youtube') || url.includes('youtu.be') ? 'üé¨' : 'üîó'}</span>
          <span class="url-chip-text">${url}</span>
          <span class="file-chip-remove" onclick="removeUrl(${index})">√ó</span>
        </div>
      `).join('');
    }

    function removeUrl(index) {
      addedUrls.splice(index, 1);
      updateUrlList();
      updateSteps();
    }

    function updateSourcePreview() {
      const preview = document.getElementById('sourcePreview');
      const content = document.getElementById('sourcePreviewContent');
      const directText = document.getElementById('directText').value;

      const fullContent = extractedContent + (directText ? `\n\n=== DIRECT INPUT ===\n${directText}` : '');

      if (fullContent.trim()) {
        preview.style.display = 'block';
        content.textContent = fullContent.substring(0, 1500) + (fullContent.length > 1500 ? '\n... [content truncated in preview]' : '');
      } else {
        preview.style.display = 'none';
      }
    }

    // Update preview when direct text changes
    document.getElementById('directText').addEventListener('input', () => {
      updateSourcePreview();
      updateSteps();
    });

    // Question Count
    let questionCount = 3;

    function adjustCount(delta) {
      questionCount = Math.max(1, Math.min(10, questionCount + delta));
      document.getElementById('questionCount').textContent = questionCount;
    }

    // Update step indicators
    function updateSteps() {
      const hasSource = extractedContent.trim() || document.getElementById('directText').value.trim() || addedUrls.length > 0;

      document.getElementById('step1').classList.toggle('completed', hasSource);
      document.getElementById('step1').classList.toggle('active', !hasSource);
      document.getElementById('step2').classList.toggle('active', hasSource);
    }

    // Generate Prompt
    function generatePrompt() {
      const directText = document.getElementById('directText').value.trim();
      const fullContent = extractedContent + (directText ? `\n\n=== DIRECT INPUT ===\n${directText}` : '');

      if (!fullContent.trim() && addedUrls.length === 0) {
        showToast('Please add source material first', 'error');
        return;
      }

      const questionType = document.getElementById('questionType').value;
      const difficulty = document.getElementById('difficulty').value;
      const domain = document.getElementById('clinicalDomain').value;
      const instructions = document.getElementById('additionalInstructions').value;

      const typeNames = {
        emq: 'Extended Matching Questions (EMQs)',
        mcq: 'Multiple Choice Questions (MCQs)',
        essay: 'Essay Questions',
        saq: 'Short Answer Questions (SAQs)',
        case: 'Clinical Case Studies',
        morphology: 'Morphology Cases',
        hplc: 'HPLC Interpretation Cases',
        viva: 'Viva Questions'
      };

      const difficultyDesc = {
        foundation: 'Foundation level (ST3-4 trainee) - testing core knowledge and common presentations',
        intermediate: 'Intermediate level (ST5-6 trainee) - testing clinical application and reasoning',
        advanced: 'Advanced level (ST7/Consultant) - testing complex scenarios and expert judgement'
      };

      // Build the prompt
      generatedPrompt = `# FRCPath Haematology Exam Question Generation Request

## Task
Generate **${questionCount} complete ${typeNames[questionType]}** for FRCPath haematology examination preparation.

## Difficulty Level
${difficultyDesc[difficulty]}

${domain ? `## Clinical Domain Focus\n${domain}\n` : ''}

## Source Material
Please use the following content as the basis for generating exam questions:

${fullContent}

${addedUrls.length > 0 ? `\n## URLs to Reference\n${addedUrls.map(u => `- ${u}`).join('\n')}\n\nPlease access and use content from these URLs.\n` : ''}

${instructions ? `## Additional Instructions\n${instructions}\n` : ''}

## Output Requirements

Please generate **${questionCount}** complete, exam-ready questions with the following structure:

${getTemplateForType(questionType)}

## Quality Standards
1. All content must align with current BSH, ISTH, NICE, and UK guidelines
2. Use UK medical terminology and spelling
3. Include specific guideline references where relevant
4. Ensure clinical accuracy and relevance to UK practice
5. Test clinical reasoning, not just factual recall

## Format
- Use clear markdown formatting
- Include headers for each question
- Provide complete answers with detailed explanations
- Add clinical pearls and learning points

---

#BloodDoctor

Please generate the questions now.`;

      // Display the prompt
      document.getElementById('outputBody').innerHTML = `
        <div class="prompt-output">${escapeHtml(generatedPrompt)}</div>
      `;

      // Update steps
      document.getElementById('step2').classList.add('completed');
      document.getElementById('step2').classList.remove('active');
      document.getElementById('step3').classList.add('active');

      showToast('Prompt generated! Click "Copy Prompt" to copy it.', 'success');
    }

    function getTemplateForType(type) {
      const templates = {
        emq: `### EMQ Structure Required:
- Theme with clinical scenario (2-3 sentences)
- 8-10 options (A-J)
- 5 linked questions
- For each question: Correct answer, detailed rationale (100-150 words), why other options are wrong, clinical pearl`,

        mcq: `### MCQ Structure Required:
- Clinical stem (2-4 sentences)
- 5 options (A-E) with one correct answer
- Correct answer with full explanation (120-150 words)
- Analysis of each distractor
- Key learning points
- Guideline references`,

        essay: `### Essay Structure Required (20 marks):
- Clear essay question
- Model answer with:
  - Introduction (2 marks, 80-120 words)
  - Section 1 (5-6 marks, 200-250 words)
  - Section 2 (5-6 marks, 200-250 words)
  - Section 3 (4-5 marks, 150-200 words)
  - Conclusion (2-3 marks, 100-120 words)
- Marking guidance`,

        saq: `### SAQ Structure Required:
- Clinical scenario
- 4-5 short answer questions (2-4 marks each)
- Model answers with key points
- Marking scheme`,

        case: `### Clinical Case Structure Required:
- Detailed patient presentation
- Investigation results (tabulated)
- Progressive questions (interpretation, differential, investigations, management)
- Complete model answers`,

        morphology: `### Morphology Case Structure Required:
- Clinical context
- Systematic description (RBCs, WBCs, platelets)
- Significant findings with interpretation
- Differential diagnosis (ranked)
- Confirmatory investigations
- Clinical pearl`,

        hplc: `### HPLC Case Structure Required:
- Patient demographics and indication
- HPLC results table with percentages
- Red cell indices
- Interpretation and pattern recognition
- Differential diagnosis
- Confirmatory tests
- Clinical implications and counselling points`,

        viva: `### Viva Question Structure Required:
- Opening question with expected answer
- Follow-up questions (progressive difficulty)
- Key points examiners look for
- Common mistakes to avoid
- Model answers at different competency levels`
      };

      return templates[type] || templates.mcq;
    }

    function escapeHtml(text) {
      return text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function copyPrompt() {
      if (!generatedPrompt) {
        showToast('Generate a prompt first', 'error');
        return;
      }

      navigator.clipboard.writeText(generatedPrompt).then(() => {
        const btn = document.getElementById('copyBtn');
        btn.textContent = '‚úì Copied!';
        btn.classList.add('copy-success');
        showToast('Prompt copied! Paste it into Claude Code.', 'success');

        setTimeout(() => {
          btn.textContent = 'üìã Copy Prompt';
          btn.classList.remove('copy-success');
        }, 2000);
      });
    }

    function clearAll() {
      uploadedFiles = [];
      addedUrls = [];
      extractedContent = '';
      generatedPrompt = '';

      updateFileList();
      updateUrlList();
      document.getElementById('directText').value = '';
      document.getElementById('additionalInstructions').value = '';
      document.getElementById('sourcePreview').style.display = 'none';
      document.getElementById('outputBody').innerHTML = `
        <div class="output-placeholder">
          <div class="output-placeholder-icon">üí¨</div>
          <div>Your prompt will appear here</div>
          <div style="font-size: 0.85rem; margin-top: 8px;">Configure settings and click "Generate Prompt"</div>
        </div>
      `;

      // Reset steps
      document.getElementById('step1').classList.add('active');
      document.getElementById('step1').classList.remove('completed');
      document.getElementById('step2').classList.remove('active', 'completed');
      document.getElementById('step3').classList.remove('active');

      showToast('Cleared all inputs', 'success');
    }

    function showToast(message, type = '') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast show ' + type;
      setTimeout(() => toast.className = 'toast', 3000);
    }
  </script>
</body>
</html>
